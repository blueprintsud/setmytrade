<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fundamental Analys Complete - SetMyTrade</title>
    <meta name="description" content="Professionell fundamental analys med 5 v√§rderingsmodeller, batch processing, charts, och CSV export.">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0D1F2D 0%, #1a2332 100%);
            color: #E0E0E0;
            min-height: 100vh;
        }
        
        /* NAVBAR */
        .smt-navbar {
            background: rgba(13, 31, 45, 0.98);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 9999;
            border-bottom: 2px solid rgba(0, 208, 132, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        .smt-navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .smt-logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #00D084;
            text-decoration: none;
        }
        .smt-nav-links {
            display: flex;
            gap: 25px;
            align-items: center;
            flex-wrap: wrap;
        }
        .smt-nav-link {
            color: #E0E0E0;
            text-decoration: none;
            font-size: 1.05em;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .smt-nav-link:hover, .smt-nav-link.active {
            background: rgba(0, 208, 132, 0.15);
            color: #00D084;
        }
        .smt-lang-toggle {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #00D084;
            color: #E0E0E0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 50px;
        }
        .header h1 {
            font-size: 3em;
            color: #00D084;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(0, 208, 132, 0.3);
        }
        .header p {
            font-size: 1.3em;
            color: #B0B0B0;
        }
        
        /* SEARCH SECTION */
        .search-section {
            background: rgba(26, 47, 61, 0.8);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(0, 208, 132, 0.2);
        }
        
        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .mode-tab {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 208, 132, 0.3);
            border-radius: 10px;
            color: #B0B0B0;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .mode-tab.active {
            background: rgba(0, 208, 132, 0.2);
            border-color: #00D084;
            color: #00D084;
        }
        .mode-tab:hover {
            background: rgba(0, 208, 132, 0.1);
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        input {
            flex: 1;
            min-width: 300px;
            padding: 15px 20px;
            background: rgba(13, 31, 45, 0.8);
            border: 2px solid rgba(0, 208, 132, 0.3);
            border-radius: 10px;
            color: #E0E0E0;
            font-size: 1.1em;
        }
        input::placeholder { color: #666; }
        input:focus {
            outline: none;
            border-color: #00D084;
            box-shadow: 0 0 20px rgba(0, 208, 132, 0.2);
        }
        
        .btn {
            padding: 15px 30px;
            background: #00D084;
            color: #0D1F2D;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #00ff9d;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 208, 132, 0.4);
        }
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #00D084;
            border: 2px solid #00D084;
        }
        .btn-secondary:hover {
            background: rgba(0, 208, 132, 0.2);
        }
        
        .actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .horizon-slider {
            margin-top: 20px;
            padding: 20px;
            background: rgba(13, 31, 45, 0.6);
            border-radius: 10px;
        }
        .horizon-slider label {
            color: #00D084;
            font-weight: 600;
            display: block;
            margin-bottom: 10px;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        input[type="range"] {
            flex: 1;
            min-width: 200px;
        }
        .horizon-value {
            color: #00D084;
            font-weight: bold;
            font-size: 1.2em;
            min-width: 80px;
        }
        
        /* LOADING */
        .loading {
            text-align: center;
            padding: 60px;
            display: none;
        }
        .loading.show { display: block; }
        .spinner {
            border: 4px solid rgba(0, 208, 132, 0.3);
            border-top: 4px solid #00D084;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            color: #00D084;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        /* MODELS SECTION */
        .models-section {
            margin: 40px 0;
            display: none;
        }
        .models-section.show { display: block; }
        .models-section h2 {
            color: #00D084;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-align: center;
        }
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        .model-card {
            background: linear-gradient(135deg, rgba(0, 208, 132, 0.1), rgba(26, 47, 61, 0.8));
            border: 2px solid rgba(0, 208, 132, 0.3);
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .model-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 208, 132, 0.4);
            border-color: #00D084;
        }
        .model-card.selected {
            border-color: #00D084;
            background: linear-gradient(135deg, rgba(0, 208, 132, 0.25), rgba(26, 47, 61, 0.9));
            box-shadow: 0 15px 40px rgba(0, 208, 132, 0.5);
        }
        .model-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 208, 132, 0.3);
            color: #00D084;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
        }
        .model-card h3 {
            color: #00D084;
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        .model-card p {
            color: #B0B0B0;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .model-features {
            list-style: none;
            padding: 0;
        }
        .model-features li {
            padding: 10px 0;
            color: #C0C0C0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.95em;
        }
        .model-features li:last-child {
            border-bottom: none;
        }
        .model-features li:before {
            content: '‚úì';
            color: #00D084;
            font-weight: bold;
            margin-right: 12px;
            font-size: 1.2em;
        }
        
        /* RESULTS */
        .results-section {
            display: none;
        }
        .results-section.show {
            display: block;
        }
        
        .stock-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .stock-card {
            background: rgba(26, 47, 61, 0.9);
            border-radius: 20px;
            padding: 35px;
            border: 2px solid rgba(0, 208, 132, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .stock-header {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(0, 208, 132, 0.2);
        }
        .stock-header h3 {
            color: #00D084;
            font-size: 2em;
            margin-bottom: 8px;
        }
        .stock-header .ticker {
            color: #B0B0B0;
            font-size: 1.2em;
            display: block;
            margin-bottom: 10px;
        }
        .stock-header .source {
            font-size: 0.85em;
            color: #666;
        }
        
        .recommendation {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.3em;
            margin: 15px 0;
            text-transform: uppercase;
        }
        .recommendation.buy, .recommendation.strongBuy {
            background: rgba(0, 208, 132, 0.25);
            color: #00D084;
            border: 2px solid #00D084;
        }
        .recommendation.hold {
            background: rgba(255, 165, 0, 0.25);
            color: #FFA500;
            border: 2px solid #FFA500;
        }
        .recommendation.sell {
            background: rgba(255, 107, 107, 0.25);
            color: #FF6B6B;
            border: 2px solid #FF6B6B;
        }
        
        .metrics-grid {
            display: grid;
            gap: 12px;
            margin: 25px 0;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: rgba(13, 31, 45, 0.7);
            border-radius: 8px;
            border-left: 4px solid #00D084;
            transition: all 0.3s;
        }
        .metric:hover {
            background: rgba(0, 208, 132, 0.1);
            transform: translateX(5px);
        }
        .metric-label {
            color: #B0B0B0;
            font-size: 0.95em;
        }
        .metric-value {
            color: #00D084;
            font-weight: bold;
            font-size: 1.15em;
        }
        
        .breakdown-section {
            margin-top: 25px;
            padding: 20px;
            background: rgba(13, 31, 45, 0.6);
            border-radius: 10px;
        }
        .breakdown-section h4 {
            color: #00D084;
            margin-bottom: 15px;
        }
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .breakdown-item:last-child {
            border-bottom: none;
        }
        
        .chart-container {
            margin-top: 30px;
            background: rgba(13, 31, 45, 0.7);
            padding: 25px;
            border-radius: 15px;
            position: relative;
            height: 350px;
        }
        
        /* COMPARE TABLE */
        .compare-table {
            background: rgba(26, 47, 61, 0.8);
            border-radius: 20px;
            padding: 30px;
            overflow-x: auto;
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        th {
            color: #00D084;
            font-weight: 600;
            position: sticky;
            top: 0;
            background: rgba(26, 47, 61, 0.95);
            font-size: 1.1em;
        }
        td {
            color: #E0E0E0;
        }
        .best {
            background: rgba(0, 208, 132, 0.2);
            color: #00D084;
            font-weight: bold;
        }
        .worst {
            background: rgba(255, 107, 107, 0.2);
            color: #FF6B6B;
        }
        
        .error {
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #FF6B6B;
            padding: 25px;
            border-radius: 15px;
            color: #FF6B6B;
            text-align: center;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            input { min-width: 100%; }
            .models-grid { grid-template-columns: 1fr; }
            .stock-cards-grid { grid-template-columns: 1fr; }
            .chart-container { height: 250px; }
        }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="smt-navbar">
        <div class="smt-navbar-container">
            <a href="index.html" class="smt-logo">SetMyTrade</a>
            <div class="smt-nav-links">
                <a href="index.html" class="smt-nav-link">Hem</a>
                <a href="fundamentals.html" class="smt-nav-link active">Fundamental</a>
                <a href="search.html" class="smt-nav-link">S√∂k</a>
                <a href="calculator.html" class="smt-nav-link">Kalkylator</a>
                <a href="calendar.html" class="smt-nav-link">Kalender</a>
                <a href="finviz.html" class="smt-nav-link">Finviz</a>
                <a href="strategies.html" class="smt-nav-link">Strategier</a>
                <a href="guides.html" class="smt-nav-link">Guider</a>
                <button class="smt-lang-toggle" onclick="changeLanguage()">
                    <span id="langBtn">üá¨üáß EN</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üìä Fundamental Analys Complete</h1>
            <p>5 V√§rderingsmodeller ‚Ä¢ Batch Processing ‚Ä¢ Charts ‚Ä¢ CSV Export ‚Ä¢ Multi-source Data</p>
        </div>

        <!-- SEARCH SECTION -->
        <div class="search-section">
            <div class="mode-tabs">
                <div class="mode-tab active" onclick="setMode('single')">üìà Single Stock</div>
                <div class="mode-tab" onclick="setMode('batch')">üìä Batch (Multiple)</div>
                <div class="mode-tab" onclick="setMode('compare')">‚öñÔ∏è Compare</div>
            </div>

            <div class="input-group">
                <input type="text" id="tickerInput" 
                       placeholder="Enter ticker (e.g. AAPL) or multiple (AAPL, MSFT, TSLA)">
                <button class="btn" onclick="fetchStocks()" id="fetchBtn">
                    üîç H√§mta Data
                </button>
            </div>

            <div class="horizon-slider">
                <label>Investeringshorisont: <span class="horizon-value" id="horizonValue">10 √•r</span></label>
                <div class="slider-container">
                    <input type="range" id="horizonSlider" min="1" max="20" value="10" 
                           oninput="updateHorizon(this.value)">
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="exportCSV()" id="exportBtn" disabled>
                    üì• Export CSV
                </button>
                <button class="btn btn-secondary" onclick="clearAll()">
                    üóëÔ∏è Clear All
                </button>
            </div>
        </div>

        <!-- LOADING -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p class="loading-text" id="loadingText">H√§mtar data fr√•n Yahoo Finance...</p>
        </div>

        <!-- MODELS SECTION -->
        <div class="models-section" id="modelsSection">
            <h2>V√§lj V√§rderingsmodell</h2>
            <div class="models-grid">
                <div class="model-card" onclick="selectModel('scoring')">
                    <span class="model-badge">Rekommenderad</span>
                    <h3>üéØ Kvantitativ Scoring</h3>
                    <p>Po√§ngbaserad v√§rdering (0-100) baserad p√• nyckeltal</p>
                    <ul class="model-features">
                        <li>L√∂nsamhet (ROE) - 30 po√§ng</li>
                        <li>V√§rdering (P/E) - 25 po√§ng</li>
                        <li>Tillv√§xt (EPS Growth) - 20 po√§ng</li>
                        <li>Finansiell h√§lsa (Debt/Equity) - 15 po√§ng</li>
                        <li>Utdelning - 10 po√§ng</li>
                    </ul>
                </div>

                <div class="model-card" onclick="selectModel('dcf')">
                    <span class="model-badge">Avancerad</span>
                    <h3>üí∞ DCF Analys</h3>
                    <p>Discounted Cash Flow v√§rdering med framtida kassafl√∂den</p>
                    <ul class="model-features">
                        <li>Framtida kassafl√∂den projekterade</li>
                        <li>Terminal v√§rde ber√§knat</li>
                        <li>Diskonteringsr√§nta 10%</li>
                        <li>Projektion 1-20 √•r (v√§lj sj√§lv)</li>
                    </ul>
                </div>

                <div class="model-card" onclick="selectModel('ddm')">
                    <span class="model-badge">Utdelning</span>
                    <h3>üíµ Utdelningsmodell (DDM)</h3>
                    <p>Gordon Growth Model f√∂r utdelningsaktier</p>
                    <ul class="model-features">
                        <li>Utdelningstillv√§xt 5% √•rligen</li>
                        <li>Avkastningskrav 10%</li>
                        <li>Total utdelning √∂ver tid</li>
                        <li>Yield on Cost ber√§knat</li>
                    </ul>
                </div>

                <div class="model-card" onclick="selectModel('peg')">
                    <span class="model-badge">Tillv√§xt</span>
                    <h3>üìà PEG Ratio</h3>
                    <p>Tillv√§xtjusterad v√§rdering (P/E √∑ Growth)</p>
                    <ul class="model-features">
                        <li>P/E ratio √∑ EPS Growth</li>
                        <li>< 1.0 = Underv√§rderad</li>
                        <li>1.0-2.0 = Rimlig v√§rdering</li>
                        <li>> 2.0 = √ñverv√§rderad</li>
                    </ul>
                </div>

                <div class="model-card" onclick="selectModel('graham')">
                    <span class="model-badge">Value</span>
                    <h3>üìö Graham Number</h3>
                    <p>Benjamin Grahams konservativa metod</p>
                    <ul class="model-features">
                        <li>Formel: ‚àö(22.5 √ó EPS √ó Book Value)</li>
                        <li>S√§kerhetsmarginal ber√§knad</li>
                        <li>Konservativ v√§rdering</li>
                        <li>Classic value investing</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- RESULTS -->
        <div class="results-section" id="resultsSection">
            <div class="stock-cards-grid" id="resultsGrid"></div>
        </div>
    </div>

    <script>
        let currentMode = 'single';
        let stocksData = [];
        let selectedModel = null;
        let investmentHorizon = 10;
        let currentCharts = [];

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const placeholder = mode === 'single' 
                ? 'Enter ticker (e.g. AAPL)'
                : mode === 'batch'
                ? 'Enter multiple tickers (e.g. AAPL, MSFT, TSLA)'
                : 'Enter tickers to compare (e.g. AAPL, MSFT)';
            document.getElementById('tickerInput').placeholder = placeholder;
        }

        function updateHorizon(value) {
            investmentHorizon = parseInt(value);
            document.getElementById('horizonValue').textContent = value + ' √•r';
            
            // Recalculate if we have results
            if (selectedModel && stocksData.length > 0) {
                calculateAndDisplay();
            }
        }

        async function fetchStocks() {
            const input = document.getElementById('tickerInput').value.trim();
            if (!input) {
                alert('Ange minst en ticker!');
                return;
            }

            const tickers = input.split(',').map(t => t.trim().toUpperCase()).filter(Boolean);
            
            document.getElementById('fetchBtn').disabled = true;
            document.getElementById('loading').classList.add('show');
            document.getElementById('modelsSection').classList.remove('show');
            document.getElementById('resultsSection').classList.remove('show');
            stocksData = [];

            try {
                for (let i = 0; i < tickers.length; i++) {
                    document.getElementById('loadingText').textContent = 
                        `H√§mtar ${tickers[i]} (${i + 1}/${tickers.length})...`;
                    
                    const data = await fetchStockData(tickers[i]);
                    if (data) {
                        stocksData.push(data);
                    }
                    
                    // Rate limit delay
                    if (i < tickers.length - 1) {
                        await sleep(600);
                    }
                }

                if (stocksData.length > 0) {
                    document.getElementById('modelsSection').classList.add('show');
                    document.getElementById('exportBtn').disabled = false;
                } else {
                    throw new Error('Kunde inte h√§mta data f√∂r n√•gra aktier');
                }

            } catch (error) {
                document.getElementById('resultsSection').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Fel uppstod</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 15px; font-size: 0.9em;">
                            F√∂rs√∂k igen eller kontrollera att ticker-symbolerna √§r korrekta.
                        </p>
                    </div>
                `;
                document.getElementById('resultsSection').classList.add('show');
            } finally {
                document.getElementById('fetchBtn').disabled = false;
                document.getElementById('loading').classList.remove('show');
            }
        }

        async function fetchStockData(ticker) {
            try {
                // Fetch with 5Y growth estimates
                const modules = 'defaultKeyStatistics,financialData,summaryDetail,quoteType,earningsTrend';
                const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${ticker}?modules=${modules}`;
                
                let response = await fetch(url);
                
                // Try CORS proxy if blocked
                if (!response.ok) {
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                    response = await fetch(proxyUrl);
                }
                
                const json = await response.json();
                const qs = json.quoteSummary.result[0];
                
                // Extract 5Y growth estimate
                const earningsTrend = qs.earningsTrend?.trend || [];
                const fiveYearGrowth = earningsTrend.find(t => t.period === '+5y')?.growth?.raw;
                
                return {
                    ticker: ticker,
                    company: qs.quoteType.longName || ticker,
                    price: qs.summaryDetail.regularMarketPrice?.raw,
                    marketCap: qs.summaryDetail.marketCap?.raw,
                    pe: qs.defaultKeyStatistics.trailingPE?.raw,
                    pb: qs.defaultKeyStatistics.priceToBook?.raw,
                    roe: qs.financialData.returnOnEquity?.raw ? qs.financialData.returnOnEquity.raw * 100 : null,
                    eps: qs.defaultKeyStatistics.trailingEps?.raw,
                    epsGrowth: qs.financialData.earningsQuarterlyGrowth?.raw ? qs.financialData.earningsQuarterlyGrowth.raw * 100 : null,
                    epsGrowth5Y: fiveYearGrowth ? fiveYearGrowth * 100 : null,
                    dividend: qs.summaryDetail.dividendYield?.raw ? qs.summaryDetail.dividendYield.raw * 100 : null,
                    debtToEquity: qs.financialData.debtToEquity?.raw,
                    profitMargin: qs.financialData.profitMargins?.raw ? qs.financialData.profitMargins.raw * 100 : null,
                    source: 'Yahoo Finance API'
                };
            } catch (e) {
                console.error(`Failed to fetch ${ticker}:`, e);
                return null;
            }
        }

        function selectModel(model) {
            selectedModel = model;
            document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            calculateAndDisplay();
        }

        function calculateAndDisplay() {
            // Destroy existing charts
            currentCharts.forEach(chart => chart.destroy());
            currentCharts = [];
            
            const results = stocksData.map(stock => {
                let result;
                switch(selectedModel) {
                    case 'scoring':
                        result = calculateScoring(stock);
                        break;
                    case 'dcf':
                        result = calculateDCF(stock);
                        break;
                    case 'ddm':
                        result = calculateDDM(stock);
                        break;
                    case 'peg':
                        result = calculatePEG(stock);
                        break;
                    case 'graham':
                        result = calculateGraham(stock);
                        break;
                    default:
                        result = calculateScoring(stock);
                }
                return { ...stock, ...result };
            });

            if (currentMode === 'compare' && results.length > 1) {
                displayCompareTable(results);
            } else {
                displayResults(results);
            }
        }

        // CALCULATION FUNCTIONS
        function calculateScoring(stock) {
            const breakdown = {
                profitability: 0,
                valuation: 0,
                growth: 0,
                financial: 0,
                dividend: 0
            };
            
            // Profitability - ROE (30 points)
            if (stock.roe) {
                if (stock.roe > 20) breakdown.profitability = 30;
                else if (stock.roe > 15) breakdown.profitability = 25;
                else if (stock.roe > 10) breakdown.profitability = 18;
                else if (stock.roe > 5) breakdown.profitability = 10;
            }
            
            // Valuation - P/E (25 points)
            if (stock.pe) {
                if (stock.pe < 15) breakdown.valuation = 25;
                else if (stock.pe < 20) breakdown.valuation = 20;
                else if (stock.pe < 25) breakdown.valuation = 15;
                else if (stock.pe < 30) breakdown.valuation = 10;
                else if (stock.pe < 40) breakdown.valuation = 5;
            }
            
            // Growth - EPS Growth (20 points)
            const growth = stock.epsGrowth5Y || stock.epsGrowth || 0;
            if (growth > 25) breakdown.growth = 20;
            else if (growth > 20) breakdown.growth = 18;
            else if (growth > 15) breakdown.growth = 15;
            else if (growth > 10) breakdown.growth = 12;
            else if (growth > 5) breakdown.growth = 8;
            
            // Financial Health - Debt/Equity (15 points)
            if (stock.debtToEquity !== null && stock.debtToEquity !== undefined) {
                if (stock.debtToEquity < 0.3) breakdown.financial = 15;
                else if (stock.debtToEquity < 0.6) breakdown.financial = 12;
                else if (stock.debtToEquity < 1.0) breakdown.financial = 9;
                else if (stock.debtToEquity < 1.5) breakdown.financial = 5;
                else if (stock.debtToEquity < 2.0) breakdown.financial = 2;
            }
            
            // Dividend (10 points)
            if (stock.dividend) {
                if (stock.dividend > 4) breakdown.dividend = 10;
                else if (stock.dividend > 3) breakdown.dividend = 8;
                else if (stock.dividend > 2) breakdown.dividend = 6;
                else if (stock.dividend > 1) breakdown.dividend = 4;
                else if (stock.dividend > 0.5) breakdown.dividend = 2;
            }
            
            const score = breakdown.profitability + breakdown.valuation + 
                         breakdown.growth + breakdown.financial + breakdown.dividend;
            
            let grade, recommendation;
            if (score >= 85) { grade = 'A+'; recommendation = 'strongBuy'; }
            else if (score >= 75) { grade = 'A'; recommendation = 'buy'; }
            else if (score >= 65) { grade = 'B+'; recommendation = 'buy'; }
            else if (score >= 55) { grade = 'B'; recommendation = 'hold'; }
            else if (score >= 45) { grade = 'C'; recommendation = 'hold'; }
            else { grade = 'D'; recommendation = 'sell'; }
            
            return {
                modelType: 'scoring',
                score: score,
                grade: grade,
                recommendation: recommendation,
                breakdown: breakdown,
                chartData: {
                    labels: ['L√∂nsamhet', 'V√§rdering', 'Tillv√§xt', 'Finansiell', 'Utdelning'],
                    values: [breakdown.profitability, breakdown.valuation, breakdown.growth, 
                            breakdown.financial, breakdown.dividend],
                    maxValues: [30, 25, 20, 15, 10]
                }
            };
        }

        function calculateDCF(stock) {
            if (!stock.eps || !stock.marketCap || !stock.profitMargin) {
                return { error: true, recommendation: 'hold', message: 'Saknar data f√∂r DCF' };
            }
            
            // Use 5Y growth if available, otherwise quarterly
            const growthRate = Math.min((stock.epsGrowth5Y || stock.epsGrowth || 8) / 100, 0.30);
            const fcfMargin = 0.15;
            const fcf = stock.marketCap * (stock.profitMargin / 100) * fcfMargin;
            const discountRate = 0.10;
            const terminalGrowth = 0.03;
            const years = investmentHorizon;
            
            let dcfValue = 0;
            let projectedValues = [stock.price];
            
            // Discount future cash flows
            for (let i = 1; i <= years; i++) {
                const projectedCF = fcf * Math.pow(1 + growthRate, i);
                const discounted = projectedCF / Math.pow(1 + discountRate, i);
                dcfValue += discounted;
                
                const projectedPrice = stock.price * Math.pow(1 + growthRate, i);
                projectedValues.push(projectedPrice);
            }
            
            // Terminal value
            const terminalCF = fcf * Math.pow(1 + growthRate, years) * (1 + terminalGrowth);
            const terminalValue = terminalCF / (discountRate - terminalGrowth);
            dcfValue += terminalValue / Math.pow(1 + discountRate, years);
            
            // Per share value
            const shares = stock.marketCap / stock.price;
            const fairValue = dcfValue / shares;
            const upside = ((fairValue - stock.price) / stock.price) * 100;
            
            let recommendation;
            if (upside > 40) recommendation = 'strongBuy';
            else if (upside > 20) recommendation = 'buy';
            else if (upside > -15) recommendation = 'hold';
            else recommendation = 'sell';
            
            return {
                modelType: 'dcf',
                fairValue: fairValue,
                upside: upside,
                recommendation: recommendation,
                projectedValues: projectedValues,
                chartData: {
                    labels: Array.from({length: years + 1}, (_, i) => `√Ör ${i}`),
                    values: projectedValues
                }
            };
        }

        function calculateDDM(stock) {
            if (!stock.dividend || stock.dividend === 0) {
                return { error: true, recommendation: 'hold', message: 'Ingen utdelning' };
            }
            
            const dividendPerShare = stock.price * (stock.dividend / 100);
            const dividendGrowth = 0.05;
            const requiredReturn = 0.10;
            const years = investmentHorizon;
            
            // Gordon Growth Model
            const fairValue = dividendPerShare * (1 + dividendGrowth) / (requiredReturn - dividendGrowth);
            const upside = ((fairValue - stock.price) / stock.price) * 100;
            
            // Calculate total dividends
            let totalDividends = 0;
            let projectedValues = [stock.price];
            
            for (let i = 1; i <= years; i++) {
                const yearDividend = dividendPerShare * Math.pow(1 + dividendGrowth, i);
                totalDividends += yearDividend;
                const totalValue = stock.price + totalDividends;
                projectedValues.push(totalValue);
            }
            
            const yieldOnCost = (totalDividends / stock.price) * 100;
            
            let recommendation;
            if (upside > 25) recommendation = 'strongBuy';
            else if (upside > 12) recommendation = 'buy';
            else if (upside > -10) recommendation = 'hold';
            else recommendation = 'sell';
            
            return {
                modelType: 'ddm',
                fairValue: fairValue,
                upside: upside,
                totalDividends: totalDividends,
                yieldOnCost: yieldOnCost,
                recommendation: recommendation,
                chartData: {
                    labels: Array.from({length: years + 1}, (_, i) => `√Ör ${i}`),
                    values: projectedValues
                }
            };
        }

        function calculatePEG(stock) {
            const growth = stock.epsGrowth5Y || stock.epsGrowth;
            if (!stock.pe || !growth || growth <= 0) {
                return { error: true, recommendation: 'hold', message: 'Saknar P/E eller growth data' };
            }
            
            const pegRatio = stock.pe / growth;
            
            let rating, recommendation;
            if (pegRatio < 0.7) {
                rating = 'Starkt Underv√§rderad';
                recommendation = 'strongBuy';
            } else if (pegRatio < 1.0) {
                rating = 'Underv√§rderad';
                recommendation = 'buy';
            } else if (pegRatio < 1.5) {
                rating = 'Rimlig V√§rdering';
                recommendation = 'buy';
            } else if (pegRatio < 2.0) {
                rating = 'N√•got √ñverv√§rderad';
                recommendation = 'hold';
            } else if (pegRatio < 2.5) {
                rating = '√ñverv√§rderad';
                recommendation = 'hold';
            } else {
                rating = 'Starkt √ñverv√§rderad';
                recommendation = 'sell';
            }
            
            return {
                modelType: 'peg',
                pegRatio: pegRatio,
                rating: rating,
                recommendation: recommendation,
                pe: stock.pe,
                growth: growth,
                chartData: {
                    value: pegRatio,
                    zones: [
                        {label: 'Underv√§rderad', max: 1.0, color: '#00D084'},
                        {label: 'Rimlig', max: 2.0, color: '#FFA500'},
                        {label: '√ñverv√§rderad', max: 3.0, color: '#FF4545'}
                    ]
                }
            };
        }

        function calculateGraham(stock) {
            if (!stock.eps || !stock.pb) {
                return { error: true, recommendation: 'hold', message: 'Saknar EPS eller P/B' };
            }
            
            const bookValue = stock.price / stock.pb;
            const grahamNumber = Math.sqrt(22.5 * stock.eps * bookValue);
            const marginOfSafety = ((grahamNumber - stock.price) / grahamNumber) * 100;
            
            let recommendation;
            if (marginOfSafety > 35) recommendation = 'strongBuy';
            else if (marginOfSafety > 20) recommendation = 'buy';
            else if (marginOfSafety > 0) recommendation = 'hold';
            else recommendation = 'sell';
            
            return {
                modelType: 'graham',
                grahamNumber: grahamNumber,
                marginOfSafety: marginOfSafety,
                recommendation: recommendation,
                chartData: {
                    labels: ['Graham Number', 'Aktuellt Pris'],
                    values: [grahamNumber, stock.price]
                }
            };
        }

        // DISPLAY FUNCTIONS
        function displayResults(results) {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = results.map((r, i) => generateResultCard(r, i)).join('');
            document.getElementById('resultsSection').classList.add('show');
            
            // Render charts after DOM update
            setTimeout(() => {
                results.forEach((r, i) => {
                    if (r.chartData && !r.error) {
                        renderChart(r, `chart-${i}`);
                    }
                });
            }, 100);
        }

        function generateResultCard(result, index) {
            const recText = {
                'strongBuy': 'üöÄ STARK K√ñP',
                'buy': '‚úÖ K√ñP',
                'hold': '‚è∏Ô∏è H√ÖLL',
                'sell': '‚ùå S√ÑLJ'
            }[result.recommendation] || 'H√ÖLL';

            let metricsHTML = '';
            
            if (result.modelType === 'scoring') {
                metricsHTML = `
                    <div class="metric">
                        <span class="metric-label">Score</span>
                        <span class="metric-value">${result.score}/100 (${result.grade})</span>
                    </div>
                    <div class="breakdown-section">
                        <h4>Po√§ng Breakdown:</h4>
                        <div class="breakdown-item">
                            <span>L√∂nsamhet (ROE)</span>
                            <span>${result.breakdown.profitability}/30</span>
                        </div>
                        <div class="breakdown-item">
                            <span>V√§rdering (P/E)</span>
                            <span>${result.breakdown.valuation}/25</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Tillv√§xt</span>
                            <span>${result.breakdown.growth}/20</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Finansiell h√§lsa</span>
                            <span>${result.breakdown.financial}/15</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Utdelning</span>
                            <span>${result.breakdown.dividend}/10</span>
                        </div>
                    </div>
                `;
            } else if (result.modelType === 'dcf') {
                metricsHTML = `
                    <div class="metric">
                        <span class="metric-label">Fair Value (DCF)</span>
                        <span class="metric-value">$${fmt(result.fairValue, 2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Upside Potential</span>
                        <span class="metric-value" style="color: ${result.upside > 0 ? '#00D084' : '#FF6B6B'}">
                            ${fmt(result.upside, 1)}%
                        </span>
                    </div>
                `;
            } else if (result.modelType === 'ddm') {
                metricsHTML = `
                    <div class="metric">
                        <span class="metric-label">Fair Value (DDM)</span>
                        <span class="metric-value">$${fmt(result.fairValue, 2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Dividends (${investmentHorizon}Y)</span>
                        <span class="metric-value">$${fmt(result.totalDividends, 2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Yield on Cost</span>
                        <span class="metric-value">${fmt(result.yieldOnCost, 2)}%</span>
                    </div>
                `;
            } else if (result.modelType === 'peg') {
                metricsHTML = `
                    <div class="metric">
                        <span class="metric-label">PEG Ratio</span>
                        <span class="metric-value">${fmt(result.pegRatio, 2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Rating</span>
                        <span class="metric-value">${result.rating}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">P/E Ratio</span>
                        <span class="metric-value">${fmt(result.pe, 2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Growth Rate</span>
                        <span class="metric-value">${fmt(result.growth, 2)}%</span>
                    </div>
                `;
            } else if (result.modelType === 'graham') {
                metricsHTML = `
                    <div class="metric">
                        <span class="metric-label">Graham Number</span>
                        <span class="metric-value">$${fmt(result.grahamNumber, 2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Margin of Safety</span>
                        <span class="metric-value" style="color: ${result.marginOfSafety > 0 ? '#00D084' : '#FF6B6B'}">
                            ${fmt(result.marginOfSafety, 1)}%
                        </span>
                    </div>
                `;
            }

            return `
                <div class="stock-card">
                    <div class="stock-header">
                        <h3>${result.company}</h3>
                        <span class="ticker">${result.ticker}</span>
                        <span class="source">üì° ${result.source}</span>
                        <div class="recommendation ${result.recommendation}">
                            ${recText}
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric">
                            <span class="metric-label">Current Price</span>
                            <span class="metric-value">$${fmt(result.price, 2)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Market Cap</span>
                            <span class="metric-value">${fmtNum(result.marketCap)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">P/E Ratio</span>
                            <span class="metric-value">${fmt(result.pe, 2)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">ROE</span>
                            <span class="metric-value">${fmt(result.roe, 2)}%</span>
                        </div>
                        ${metricsHTML}
                    </div>
                    
                    ${!result.error ? `
                    <div class="chart-container">
                        <canvas id="chart-${index}"></canvas>
                    </div>
                    ` : `
                    <div class="error" style="margin-top: 20px;">
                        ‚ö†Ô∏è ${result.message}
                    </div>
                    `}
                </div>
            `;
        }

        function renderChart(result, canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let config;
            
            if (result.modelType === 'scoring') {
                config = {
                    type: 'radar',
                    data: {
                        labels: result.chartData.labels,
                        datasets: [{
                            label: 'Score',
                            data: result.chartData.values,
                            backgroundColor: 'rgba(0, 208, 132, 0.2)',
                            borderColor: '#00D084',
                            borderWidth: 2,
                            pointBackgroundColor: '#00D084'
                        }, {
                            label: 'Max',
                            data: result.chartData.maxValues,
                            backgroundColor: 'rgba(255, 255, 255, 0.05)',
                            borderColor: 'rgba(255, 255, 255, 0.3)',
                            borderWidth: 1,
                            pointBackgroundColor: 'rgba(255, 255, 255, 0.3)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                pointLabels: { color: '#B0B0B0', font: { size: 12 } },
                                ticks: { color: '#B0B0B0', backdropColor: 'transparent' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#E0E0E0' } }
                        }
                    }
                };
            } else if (result.modelType === 'dcf' || result.modelType === 'ddm') {
                config = {
                    type: 'line',
                    data: {
                        labels: result.chartData.labels,
                        datasets: [{
                            label: result.modelType === 'dcf' ? 'Projected Price' : 'Total Value',
                            data: result.chartData.values,
                            borderColor: '#00D084',
                            backgroundColor: 'rgba(0, 208, 132, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#B0B0B0' }
                            },
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#B0B0B0' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#E0E0E0' } }
                        }
                    }
                };
            } else if (result.modelType === 'graham') {
                config = {
                    type: 'bar',
                    data: {
                        labels: result.chartData.labels,
                        datasets: [{
                            label: 'Value',
                            data: result.chartData.values,
                            backgroundColor: ['#00D084', '#FFA500']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#B0B0B0' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#B0B0B0' }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                };
            } else if (result.modelType === 'peg') {
                config = {
                    type: 'doughnut',
                    data: {
                        labels: result.chartData.zones.map(z => z.label),
                        datasets: [{
                            data: [1, 1, 1],
                            backgroundColor: result.chartData.zones.map(z => z.color)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#E0E0E0' } }
                        }
                    }
                };
            }
            
            if (config) {
                const chart = new Chart(ctx, config);
                currentCharts.push(chart);
            }
        }

        function displayCompareTable(results) {
            const metrics = [
                { key: 'price', label: 'Price', format: (v) => '$' + fmt(v, 2), higher: false },
                { key: 'marketCap', label: 'Market Cap', format: fmtNum, higher: true },
                { key: 'pe', label: 'P/E', format: (v) => fmt(v, 2), higher: false },
                { key: 'pb', label: 'P/B', format: (v) => fmt(v, 2), higher: false },
                { key: 'roe', label: 'ROE (%)', format: (v) => fmt(v, 2) + '%', higher: true },
                { key: 'eps', label: 'EPS', format: (v) => '$' + fmt(v, 2), higher: true },
                { key: 'epsGrowth5Y', label: '5Y Growth (%)', format: (v) => fmt(v, 2) + '%', higher: true },
                { key: 'dividend', label: 'Dividend (%)', format: (v) => fmt(v, 2) + '%', higher: true },
                { key: 'debtToEquity', label: 'Debt/Equity', format: (v) => fmt(v, 2), higher: false }
            ];

            let html = '<div class="compare-table"><h2 style="color: #00D084; margin-bottom: 25px; text-align: center;">Stock Comparison</h2><table><thead><tr><th>Metric</th>';
            results.forEach(r => html += `<th>${r.ticker}</th>`);
            html += '</tr></thead><tbody>';

            metrics.forEach(metric => {
                html += `<tr><td><strong>${metric.label}</strong></td>`;
                
                const values = results.map(r => r[metric.key]).filter(v => v !== null && v !== undefined && !isNaN(v));
                const best = values.length > 0 ? (metric.higher ? Math.max(...values) : Math.min(...values)) : null;
                const worst = values.length > 0 ? (metric.higher ? Math.min(...values) : Math.max(...values)) : null;

                results.forEach(stock => {
                    const value = stock[metric.key];
                    let className = '';
                    if (value === best && values.length > 1) className = 'best';
                    else if (value === worst && values.length > 1) className = 'worst';
                    
                    html += `<td class="${className}">${value !== null && value !== undefined ? metric.format(value) : 'N/A'}</td>`;
                });
                
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            
            document.getElementById('resultsGrid').innerHTML = html;
            document.getElementById('resultsSection').classList.add('show');
        }

        function exportCSV() {
            const headers = ['Ticker', 'Company', 'Price', 'Market Cap', 'P/E', 'P/B', 'ROE (%)', 'EPS', '5Y Growth (%)', 'Dividend (%)', 'Debt/Equity', 'Profit Margin (%)'];
            
            const rows = stocksData.map(s => [
                s.ticker,
                s.company,
                s.price,
                s.marketCap,
                s.pe,
                s.pb,
                s.roe,
                s.eps,
                s.epsGrowth5Y || s.epsGrowth,
                s.dividend,
                s.debtToEquity,
                s.profitMargin
            ]);

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fundamentals-analysis-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAll() {
            document.getElementById('tickerInput').value = '';
            document.getElementById('modelsSection').classList.remove('show');
            document.getElementById('resultsSection').classList.remove('show');
            document.getElementById('exportBtn').disabled = true;
            stocksData = [];
            selectedModel = null;
            currentCharts.forEach(c => c.destroy());
            currentCharts = [];
        }

        function changeLanguage() {
            const btn = document.getElementById('langBtn');
            btn.textContent = btn.textContent.includes('EN') ? 'üá∏üá™ SV' : 'üá¨üáß EN';
        }

        function fmt(val, decimals = 2) {
            if (val === null || val === undefined || isNaN(val)) return 'N/A';
            return val.toFixed(decimals);
        }

        function fmtNum(num) {
            if (!num || isNaN(num)) return 'N/A';
            const suffixes = ['', 'K', 'M', 'B', 'T'];
            let tier = Math.log10(Math.abs(num)) / 3 | 0;
            if (tier == 0) return num.toLocaleString();
            const suffix = suffixes[tier];
            const scale = Math.pow(10, tier * 3);
            return (num / scale).toFixed(2) + suffix;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Enter key support
        document.getElementById('tickerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') fetchStocks();
        });
    </script>
</body>
</html>
