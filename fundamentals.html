<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fundamental Analys - SetMyTrade</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0D1F2D 0%, #1a2332 100%);
            color: #E0E0E0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 3em;
            color: #00D084;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 208, 132, 0.3);
        }

        .subtitle {
            font-size: 1.2em;
            color: #B0B0B0;
        }

        .language-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .lang-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #00D084;
            color: #E0E0E0;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .lang-btn.active {
            background: #00D084;
            color: #0D1F2D;
        }

        .lang-btn:hover {
            background: rgba(0, 208, 132, 0.2);
        }

        .search-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 208, 132, 0.3);
            border-radius: 10px;
            color: #E0E0E0;
            font-size: 1.1em;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #00D084;
        }

        button {
            padding: 15px 30px;
            background: #00D084;
            border: none;
            border-radius: 10px;
            color: #0D1F2D;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        button:hover {
            background: #00ff9d;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 208, 132, 0.4);
        }

        .data-source {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #B0B0B0;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #888;
        }

        .status-dot.success {
            background: #00D084;
            box-shadow: 0 0 10px #00D084;
        }

        .status-dot.loading {
            background: #FFA500;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .horizon-selector {
            margin-top: 20px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(0, 208, 132, 0.2);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00D084;
            cursor: pointer;
        }

        .horizon-value {
            font-size: 1.2em;
            color: #00D084;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }

        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .model-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid rgba(0, 208, 132, 0.2);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .model-card:hover {
            border-color: #00D084;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 208, 132, 0.3);
        }

        .model-card.selected {
            border-color: #00D084;
            background: rgba(0, 208, 132, 0.1);
        }

        .model-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: #00D084;
            color: #0D1F2D;
            border-radius: 5px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .model-title {
            font-size: 1.4em;
            color: #00D084;
            margin-bottom: 10px;
        }

        .model-desc {
            color: #B0B0B0;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .model-features {
            list-style: none;
            font-size: 0.85em;
        }

        .model-features li {
            padding: 5px 0;
            color: #C0C0C0;
        }

        .model-features li:before {
            content: "âœ“ ";
            color: #00D084;
            font-weight: bold;
        }

        .results-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(0, 208, 132, 0.2);
        }

        .stock-info h2 {
            font-size: 2em;
            color: #00D084;
        }

        .stock-info .ticker {
            color: #B0B0B0;
            font-size: 1.2em;
        }

        .recommendation {
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
        }

        .recommendation.buy {
            background: rgba(0, 208, 132, 0.2);
            color: #00D084;
            border: 2px solid #00D084;
        }

        .recommendation.hold {
            background: rgba(255, 165, 0, 0.2);
            color: #FFA500;
            border: 2px solid #FFA500;
        }

        .recommendation.sell {
            background: rgba(255, 69, 69, 0.2);
            color: #FF4545;
            border: 2px solid #FF4545;
        }

        .result-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .result-content {
                grid-template-columns: 1fr;
            }
        }

        .metrics {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 10px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #B0B0B0;
        }

        .metric-value {
            color: #00D084;
            font-weight: bold;
            font-size: 1.1em;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 10px;
            height: 400px;
        }

        canvas {
            max-height: 100%;
        }

        .manual-input-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #00D084;
            border: 2px solid #00D084;
        }

        .manual-input-btn:hover {
            background: rgba(0, 208, 132, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a2332;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            color: #00D084;
        }

        .close-btn {
            background: none;
            color: #E0E0E0;
            font-size: 2em;
            padding: 0;
            width: 40px;
            height: 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #B0B0B0;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .form-group input {
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 208, 132, 0.3);
            border-radius: 8px;
            color: #E0E0E0;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00D084;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #00D084;
        }

        .error {
            background: rgba(255, 69, 69, 0.2);
            border: 2px solid #FF4545;
            padding: 20px;
            border-radius: 10px;
            color: #FF4545;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="language-toggle">
        <button class="lang-btn active" onclick="setLanguage('sv')">ðŸ‡¸ðŸ‡ª SV</button>
        <button class="lang-btn" onclick="setLanguage('en')">ðŸ‡¬ðŸ‡§ EN</button>
    </div>

    <div class="container">
        <header>
            <h1 id="mainTitle">Fundamental Analys</h1>
            <p class="subtitle" id="subtitle">Professionell aktieanalys med 5 olika vÃ¤rderingsmodeller</p>
        </header>

        <div class="search-section">
            <div class="search-box">
                <input type="text" id="tickerInput" placeholder="Ange aktiesymbol (t.ex. AAPL) eller flera (

            <div class="horizon-selector">
                <label id="horizonLabel">Investeringshorisont:</label>
                <div class="slider-container">
                    <input type="range" id="horizonSlider" min="1" max="20" value="10">
                    <div class="horizon-value"><span id="horizonValue">10</span> Ã¥r</div>
                </div>
            </div>
        </div>

        <h2 style="color: #00D084; margin-bottom: 20px;" id="modelsTitle">VÃ¤lj VÃ¤rderingsmodell</h2>
        
        <div class="models-grid" id="modelsGrid">
            <!-- Models populated by JavaScript -->
        </div>

        <div class="results-section" id="resultsSection">
            <div class="result-header">
                <div class="stock-info">
                    <h2 id="companyName">â€”</h2>
                    <div class="ticker" id="tickerSymbol">â€”</div>
                </div>
                <div class="recommendation" id="recommendation">â€”</div>
            </div>

            <div class="result-content">
                <div class="metrics" id="metricsContainer">
                    <!-- Metrics populated by JavaScript -->
                </div>
                <div class="chart-container">
                    <canvas id="resultChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Input Modal -->
    <div class="modal" id="manualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Manuell Datainmatning</h2>
                <button class="close-btn" onclick="closeManualInput()">&times;</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>FÃ¶retag:</label>
                    <input type="text" id="manualCompany" placeholder="Apple Inc">
                </div>
                <div class="form-group">
                    <label>Ticker:</label>
                    <input type="text" id="manualTicker" placeholder="AAPL">
                </div>
                <div class="form-group">
                    <label>Pris ($):</label>
                    <input type="number" id="manualPrice" step="0.01" placeholder="248.05">
                </div>
                <div class="form-group">
                    <label>P/E:</label>
                    <input type="number" id="manualPE" step="0.01" placeholder="33.25">
                </div>
                <div class="form-group">
                    <label>ROE (%):</label>
                    <input type="number" id="manualROE" step="0.01" placeholder="171.42">
                </div>
                <div class="form-group">
                    <label>EPS TillvÃ¤xt (%):</label>
                    <input type="number" id="manualGrowth" step="0.01" placeholder="10.34">
                </div>
                <div class="form-group">
                    <label>P/B:</label>
                    <input type="number" id="manualPB" step="0.01" placeholder="49.70">
                </div>
                <div class="form-group">
                    <label>Utdelning (%):</label>
                    <input type="number" id="manualDividend" step="0.01" placeholder="0.42">
                </div>
                <div class="form-group">
                    <label>Debt/Equity:</label>
                    <input type="number" id="manualDebt" step="0.01" placeholder="1.52">
                </div>
                <div class="form-group">
                    <label>Vinstmarginal (%):</label>
                    <input type="number" id="manualMargin" step="0.01" placeholder="26.92">
                </div>
                <div class="form-group">
                    <label>EPS ($):</label>
                    <input type="number" id="manualEPS" step="0.01" placeholder="7.46">
                </div>
                <div class="form-group">
                    <label>Market Cap (B):</label>
                    <input type="number" id="manualMarketCap" step="0.01" placeholder="3645.82">
                </div>
            </div>
            <button onclick="useManualData()" style="width: 100%; margin-top: 30px;" id="useManualBtn">AnvÃ¤nd Data</button>
        </div>
    </div>

    <script>
        // Global variables
        let currentLanguage = 'sv';
        let stockData = null;
        let selectedModel = null;
        let investmentHorizon = 10;
        let currentChart = null;

        // Translations
        const translations = {
            sv: {
                mainTitle: "Fundamental Analys",
                subtitle: "Professionell aktieanalys med 5 olika vÃ¤rderingsmodeller",
                searchBtn: "SÃ¶k",
                manualBtn: "Fyll i Manuellt",
                horizonLabel: "Investeringshorisont:",
                modelsTitle: "VÃ¤lj VÃ¤rderingsmodell",
                modalTitle: "Manuell Datainmatning",
                useManualBtn: "AnvÃ¤nd Data",
                waitingSearch: "VÃ¤ntar pÃ¥ sÃ¶kning...",
                fetchingData: "HÃ¤mtar data frÃ¥n",
                dataReady: "Data klar",
                years: "Ã¥r",
                models: {
                    scoring: {
                        title: "Kvantitativ Scoring",
                        badge: "REKOMMENDERAD",
                        desc: "PoÃ¤ngbaserad vÃ¤rdering (0-100)",
                        features: [
                            "LÃ¶nsamhet (ROE) - 30p",
                            "VÃ¤rdering (P/E) - 25p",
                            "TillvÃ¤xt - 20p",
                            "Finansiell hÃ¤lsa - 15p",
                            "Utdelning - 10p"
                        ]
                    },
                    dcf: {
                        title: "DCF Analys",
                        badge: "AVANCERAD",
                        desc: "Discounted Cash Flow vÃ¤rdering",
                        features: [
                            "Framtida kassaflÃ¶den",
                            "Terminal vÃ¤rde",
                            "DiskonteringsrÃ¤nta 10%",
                            "Projektion 1-20 Ã¥r"
                        ]
                    },
                    ddm: {
                        title: "Utdelningsmodell",
                        badge: "UTDELNING",
                        desc: "Gordon Growth Model",
                        features: [
                            "UtdelningstillvÃ¤xt 5%",
                            "Avkastningskrav 10%",
                            "Total utdelning",
                            "Yield on Cost"
                        ]
                    },
                    peg: {
                        title: "PEG Ratio",
                        badge: "TILLVÃ„XT",
                        desc: "TillvÃ¤xtjusterad vÃ¤rdering",
                        features: [
                            "P/E Ã· TillvÃ¤xt",
                            "Under 1.0 = UndervÃ¤rderad",
                            "1.0-2.0 = Rimlig",
                            "Ã–ver 2.0 = Ã–vervÃ¤rderad"
                        ]
                    },
                    graham: {
                        title: "Graham Number",
                        badge: "VALUE",
                        desc: "Ben Graham's vÃ¤rdeinvestering",
                        features: [
                            "âˆš(22.5 Ã— EPS Ã— BokfÃ¶rt vÃ¤rde)",
                            "SÃ¤kerhetsmarginal",
                            "Konservativ vÃ¤rdering",
                            "Value investing"
                        ]
                    }
                },
                recommendations: {
                    strongBuy: "STARK KÃ–P",
                    buy: "KÃ–P",
                    hold: "HÃ…LL",
                    sell: "SÃ„LJ",
                    strongSell: "STARK SÃ„LJ"
                }
            },
            en: {
                mainTitle: "Fundamental Analysis",
                subtitle: "Professional stock analysis with 5 different valuation models",
                searchBtn: "Search",
                manualBtn: "Manual Input",
                horizonLabel: "Investment Horizon:",
                modelsTitle: "Choose Valuation Model",
                modalTitle: "Manual Data Input",
                useManualBtn: "Use Data",
                waitingSearch: "Waiting for search...",
                fetchingData: "Fetching data from",
                dataReady: "Data ready",
                years: "years",
                models: {
                    scoring: {
                        title: "Quantitative Scoring",
                        badge: "RECOMMENDED",
                        desc: "Score-based valuation (0-100)",
                        features: [
                            "Profitability (ROE) - 30pts",
                            "Valuation (P/E) - 25pts",
                            "Growth - 20pts",
                            "Financial Health - 15pts",
                            "Dividend - 10pts"
                        ]
                    },
                    dcf: {
                        title: "DCF Analysis",
                        badge: "ADVANCED",
                        desc: "Discounted Cash Flow valuation",
                        features: [
                            "Future cash flows",
                            "Terminal value",
                            "Discount rate 10%",
                            "1-20 year projection"
                        ]
                    },
                    ddm: {
                        title: "Dividend Model",
                        badge: "DIVIDEND",
                        desc: "Gordon Growth Model",
                        features: [
                            "Dividend growth 5%",
                            "Required return 10%",
                            "Total dividends",
                            "Yield on Cost"
                        ]
                    },
                    peg: {
                        title: "PEG Ratio",
                        badge: "GROWTH",
                        desc: "Growth-adjusted valuation",
                        features: [
                            "P/E Ã· Growth",
                            "Under 1.0 = Undervalued",
                            "1.0-2.0 = Fair",
                            "Over 2.0 = Overvalued"
                        ]
                    },
                    graham: {
                        title: "Graham Number",
                        badge: "VALUE",
                        desc: "Ben Graham's value investing",
                        features: [
                            "âˆš(22.5 Ã— EPS Ã— Book Value)",
                            "Margin of Safety",
                            "Conservative valuation",
                            "Value investing"
                        ]
                    }
                },
                recommendations: {
                    strongBuy: "STRONG BUY",
                    buy: "BUY",
                    hold: "HOLD",
                    sell: "SELL",
                    strongSell: "STRONG SELL"
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderModels();
            
            // Horizon slider
            document.getElementById('horizonSlider').addEventListener('input', (e) => {
                investmentHorizon = parseInt(e.target.value);
                document.getElementById('horizonValue').textContent = investmentHorizon;
            });

            // Enter key for search
            document.getElementById('tickerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchStock();
            });
        });

        function setLanguage(lang) {
            currentLanguage = lang;
            
            // Update buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update text
            const t = translations[lang];
            document.getElementById('mainTitle').textContent = t.mainTitle;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('searchBtn').textContent = t.searchBtn;
            document.getElementById('manualBtn').textContent = t.manualBtn;
            document.getElementById('horizonLabel').textContent = t.horizonLabel;
            document.getElementById('modelsTitle').textContent = t.modelsTitle;
            document.getElementById('modalTitle').textContent = t.modalTitle;
            document.getElementById('useManualBtn').textContent = t.useManualBtn;
            
            // Re-render models
            renderModels();
        }

        function renderModels() {
            const grid = document.getElementById('modelsGrid');
            const t = translations[currentLanguage];
            
            grid.innerHTML = Object.entries(t.models).map(([key, model]) => `
                <div class="model-card" onclick="selectModel('${key}')">
                    <div class="model-badge">${model.badge}</div>
                    <div class="model-title">${model.title}</div>
                    <div class="model-desc">${model.desc}</div>
                    <ul class="model-features">
                        ${model.features.map(f => `<li>${f}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }

        function selectModel(modelKey) {
            selectedModel = modelKey;
            
            // Visual feedback
            document.querySelectorAll('.model-card').forEach((card, index) => {
                const keys = Object.keys(translations[currentLanguage].models);
                if (keys[index] === modelKey) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            // Calculate if we have data
            if (stockData) {
                calculate();
            }
        }

        async function searchStock() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (!ticker) {
                alert('Please enter a ticker symbol');
                return;
            }
            
            const statusDot = document.getElementById('statusDot');
            const dataSource = document.getElementById('dataSource');
            const t = translations[currentLanguage];
            
            statusDot.className = 'status-dot loading';
            dataSource.textContent = `${t.fetchingData} market data...`;
            
            // Try 3-level fallback
            stockData = await fetchWithFallback(ticker);
            
            if (stockData) {
                statusDot.className = 'status-dot success';
                dataSource.textContent = `${t.dataReady} (${stockData.dataSource || 'Finviz'})`;
            } else {
                statusDot.className = 'status-dot';
                dataSource.textContent = 'Failed to fetch data';
                showManualInput();
            }
        }

        async function fetchYahooFinance(ticker) {
            try {
                const options = {
                    method: 'GET',
                    headers: {
                        'x-rapidapi-host': 'apidojo-yahoo-finance-v1.p.rapidapi.com',
                        'x-rapidapi-key': 'e8d51696e2msh6316528ba069319p1d9c30jsn22c0216eaa00'
                    }
                };
                
                const url = `https://apidojo-yahoo-finance-v1.p.rapidapi.com/stock/v2/get-summary?symbol=${ticker}&region=US`;
                const response = await fetch(url, options);
                
                if (!response.ok) return null;
                
                const data = await response.json();
                const price = data.price?.regularMarketPrice?.raw;
                const summary = data.summaryDetail;
                const financials = data.defaultKeyStatistics;
                const finData = data.financialData;
                
                return {
                    ticker: ticker,
                    company: data.quoteType?.longName || ticker,
                    price: price,
                    pe: financials?.trailingPE?.raw || summary?.trailingPE?.raw,
                    pb: financials?.priceToBook?.raw,
                    roe: finData?.returnOnEquity?.raw ? finData.returnOnEquity.raw * 100 : null,
                    dividend: summary?.dividendYield?.raw ? summary.dividendYield.raw * 100 : null,
                    eps: financials?.trailingEps?.raw,
                    epsGrowth: finData?.earningsQuarterlyGrowth?.raw ? finData.earningsQuarterlyGrowth.raw * 100 : 
                               (finData?.earningsGrowth?.raw ? finData.earningsGrowth.raw * 100 : null),
                    margin: finData?.profitMargins?.raw ? finData.profitMargins.raw * 100 : null,
                    debt: finData?.debtToEquity?.raw || financials?.debtToEquity?.raw,
                    marketCap: data.price?.marketCap?.raw || summary?.marketCap?.raw,
                    dataSource: 'Yahoo Finance (RapidAPI)'
                };
            } catch (e) {
                console.log('Yahoo Finance failed:', e);
                return null;
            }
        }

        async function fetchWithFallback(ticker) {
            // Level 1: Try Render API
            try {
                const renderResp = await fetch(`https://setmytrade-api.onrender.com/api/finviz?ticker=${ticker}`, {
                    signal: AbortSignal.timeout(5000)
                });
                if (renderResp.ok) {
                    const data = await renderResp.json();
                    if (data.price) {
                        data.dataSource = 'Render API';
                        return data;
                    }
                }
            } catch (e) {
                console.log('Render API failed:', e.message);
            }
            
            // Level 2: Try Yahoo Finance (RapidAPI)
            try {
                const yahooData = await fetchYahooFinance(ticker);
                if (yahooData && yahooData.price) {
                    return yahooData;
                }
            } catch (e) {
                console.log('Yahoo Finance failed:', e.message);
            }
            
            // Level 3: CORS Proxy + Finviz scraping
            const proxies = [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?'
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = proxy + encodeURIComponent(`https://finviz.com/quote.ashx?t=${ticker}`);
                    const resp = await fetch(url, { signal: AbortSignal.timeout(5000) });
                    if (resp.ok) {
                        const html = await resp.text();
                        
                        // Validate HTML (not error page)
                        if (!html.includes('snapshot-table') || html.length < 5000) {
                            console.log('Invalid HTML from proxy');
                            continue;
                        }
                        
                        const parsed = parseFinvizHTML(html, ticker);
                        if (parsed && parsed.price) {
                            parsed.dataSource = 'Finviz (CORS Proxy)';
                            return parsed;
                        }
                    }
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            
            // Level 3: Manual input
            return null;
        }

        function parseFinvizHTML(html, ticker) {
            try {
                // Extract company name from title
                const titleMatch = html.match(/<title>([^|]+)/);
                const company = titleMatch ? titleMatch[1].trim() : ticker;
                
                // Parse table data
                const data = {};
                const tableRegex = /<td[^>]*class="snapshot-td2[^"]*"[^>]*>([^<]+)<\/td>\s*<td[^>]*class="snapshot-td2[^"]*"[^>]*>([^<]*(?:<[^>]*>[^<]*<\/[^>]*>)?[^<]*)<\/td>/g;
                
                let match;
                while ((match = tableRegex.exec(html)) !== null) {
                    const label = match[1].trim();
                    const value = match[2].replace(/<[^>]*>/g, '').trim();
                    data[label] = value;
                }
                
                // Parse numbers
                const parseNum = (str) => {
                    if (!str || str === '-') return null;
                    str = str.replace(/%/g, '').replace(/,/g, '');
                    
                    let mult = 1;
                    if (str.includes('B')) { mult = 1e9; str = str.replace('B', ''); }
                    else if (str.includes('M')) { mult = 1e6; str = str.replace('M', ''); }
                    else if (str.includes('K')) { mult = 1e3; str = str.replace('K', ''); }
                    
                    const num = parseFloat(str);
                    return isNaN(num) ? null : num * mult;
                };
                
                return {
                    ticker: ticker,
                    company: company,
                    price: parseNum(data['Price']),
                    pe: parseNum(data['P/E']),
                    pb: parseNum(data['P/B']),
                    roe: parseNum(data['ROE']),
                    dividend: parseNum(data['Dividend %']),
                    eps: parseNum(data['EPS (ttm)']),
                    epsGrowth: parseNum(data['EPS this Y']),
                    margin: parseNum(data['Profit Margin']),
                    debt: parseNum(data['Debt/Eq']),
                    marketCap: parseNum(data['Market Cap'])
                };
            } catch (e) {
                console.error('Parse error:', e);
                return null;
            }
        }

        function showManualInput() {
            document.getElementById('manualModal').classList.add('show');
        }

        function closeManualInput() {
            document.getElementById('manualModal').classList.remove('show');
        }

        function useManualData() {
            stockData = {
                company: document.getElementById('manualCompany').value,
                ticker: document.getElementById('manualTicker').value,
                price: parseFloat(document.getElementById('manualPrice').value),
                pe: parseFloat(document.getElementById('manualPE').value),
                roe: parseFloat(document.getElementById('manualROE').value),
                epsGrowth: parseFloat(document.getElementById('manualGrowth').value),
                pb: parseFloat(document.getElementById('manualPB').value),
                dividend: parseFloat(document.getElementById('manualDividend').value),
                debt: parseFloat(document.getElementById('manualDebt').value),
                margin: parseFloat(document.getElementById('manualMargin').value),
                eps: parseFloat(document.getElementById('manualEPS').value),
                marketCap: parseFloat(document.getElementById('manualMarketCap').value) * 1e9,
                dataSource: 'Manual Input'
            };
            
            closeManualInput();
            
            const statusDot = document.getElementById('statusDot');
            const dataSource = document.getElementById('dataSource');
            statusDot.className = 'status-dot success';
            dataSource.textContent = 'Data ready (Manual Input)';
        }

        function calculate() {
            if (!stockData || !selectedModel) {
                alert('Please search for a stock and select a model');
                return;
            }
            
            let result;
            switch(selectedModel) {
                case 'scoring':
                    result = calculateScoring();
                    break;
                case 'dcf':
                    result = calculateDCF();
                    break;
                case 'ddm':
                    result = calculateDDM();
                    break;
                case 'peg':
                    result = calculatePEG();
                    break;
                case 'graham':
                    result = calculateGraham();
                    break;
            }
            
            displayResults(result);
        }

        function calculateScoring() {
            const breakdown = {
                profitability: 0,
                valuation: 0,
                growth: 0,
                financial: 0,
                dividend: 0
            };
            
            // Profitability (30 points)
            if (stockData.roe > 20) breakdown.profitability = 30;
            else if (stockData.roe > 15) breakdown.profitability = 25;
            else if (stockData.roe > 10) breakdown.profitability = 20;
            else if (stockData.roe > 5) breakdown.profitability = 10;
            
            // Valuation (25 points)
            if (stockData.pe < 15) breakdown.valuation = 25;
            else if (stockData.pe < 20) breakdown.valuation = 20;
            else if (stockData.pe < 25) breakdown.valuation = 15;
            else if (stockData.pe < 30) breakdown.valuation = 10;
            
            // Growth (20 points)
            if (stockData.epsGrowth > 20) breakdown.growth = 20;
            else if (stockData.epsGrowth > 15) breakdown.growth = 17;
            else if (stockData.epsGrowth > 10) breakdown.growth = 14;
            else if (stockData.epsGrowth > 5) breakdown.growth = 10;
            
            // Financial Health (15 points)
            if (stockData.debt < 0.3) breakdown.financial = 15;
            else if (stockData.debt < 0.6) breakdown.financial = 12;
            else if (stockData.debt < 1.0) breakdown.financial = 8;
            else if (stockData.debt < 1.5) breakdown.financial = 4;
            
            // Dividend (10 points)
            if (stockData.dividend > 4) breakdown.dividend = 10;
            else if (stockData.dividend > 3) breakdown.dividend = 8;
            else if (stockData.dividend > 2) breakdown.dividend = 6;
            else if (stockData.dividend > 1) breakdown.dividend = 4;
            
            const score = breakdown.profitability + breakdown.valuation + breakdown.growth + breakdown.financial + breakdown.dividend;
            
            let grade, recommendation;
            if (score >= 80) { grade = 'A+'; recommendation = 'strongBuy'; }
            else if (score >= 70) { grade = 'A'; recommendation = 'buy'; }
            else if (score >= 60) { grade = 'B'; recommendation = 'buy'; }
            else if (score >= 50) { grade = 'C'; recommendation = 'hold'; }
            else { grade = 'D'; recommendation = 'sell'; }
            
            return {
                modelType: 'scoring',
                score,
                grade,
                recommendation,
                breakdown,
                chartData: {
                    labels: ['Profitability', 'Valuation', 'Growth', 'Financial', 'Dividend'],
                    values: [breakdown.profitability, breakdown.valuation, breakdown.growth, breakdown.financial, breakdown.dividend],
                    maxValues: [30, 25, 20, 15, 10]
                }
            };
        }

        function calculateDCF() {
            // Proper DCF calculation
            const fcfMargin = 0.15; // Conservative FCF margin
            const fcf = stockData.marketCap * (stockData.margin / 100) * fcfMargin;
            const growthRate = Math.min((stockData.epsGrowth || 10) / 100, 0.25);
            const discountRate = 0.10;
            const terminalGrowth = 0.03;
            const years = investmentHorizon;
            
            let dcfValue = 0;
            let projectedValues = [stockData.price];
            
            // Discount future cash flows
            for (let i = 1; i <= years; i++) {
                const projectedCF = fcf * Math.pow(1 + growthRate, i);
                const discounted = projectedCF / Math.pow(1 + discountRate, i);
                dcfValue += discounted;
                
                // Project stock price
                const projectedPrice = stockData.price * Math.pow(1 + growthRate, i);
                projectedValues.push(projectedPrice);
            }
            
            // Terminal value
            const terminalCF = fcf * Math.pow(1 + growthRate, years) * (1 + terminalGrowth);
            const terminalValue = terminalCF / (discountRate - terminalGrowth);
            dcfValue += terminalValue / Math.pow(1 + discountRate, years);
            
            // Per share value
            const shares = stockData.marketCap / stockData.price;
            const fairValue = dcfValue / shares;
            const upside = ((fairValue - stockData.price) / stockData.price) * 100;
            
            let recommendation;
            if (upside > 30) recommendation = 'strongBuy';
            else if (upside > 15) recommendation = 'buy';
            else if (upside > -10) recommendation = 'hold';
            else recommendation = 'sell';
            
            return {
                modelType: 'dcf',
                fairValue,
                currentPrice: stockData.price,
                upside,
                projectedValues,
                recommendation,
                chartData: {
                    labels: Array.from({length: years + 1}, (_, i) => `Year ${i}`),
                    values: projectedValues
                }
            };
        }

        function calculateDDM() {
            if (!stockData.dividend || stockData.dividend === 0) {
                return {
                    error: true,
                    message: 'No dividend data available'
                };
            }
            
            const dividendPerShare = stockData.price * (stockData.dividend / 100);
            const dividendGrowth = 0.05;
            const requiredReturn = 0.10;
            const years = investmentHorizon;
            
            // Gordon Growth Model
            const fairValue = dividendPerShare * (1 + dividendGrowth) / (requiredReturn - dividendGrowth);
            const upside = ((fairValue - stockData.price) / stockData.price) * 100;
            
            // Calculate total dividends
            let totalDividends = 0;
            let projectedValues = [stockData.price];
            
            for (let i = 1; i <= years; i++) {
                const yearDividend = dividendPerShare * Math.pow(1 + dividendGrowth, i);
                totalDividends += yearDividend;
                const totalValue = stockData.price + totalDividends;
                projectedValues.push(totalValue);
            }
            
            const yieldOnCost = (totalDividends / stockData.price) * 100;
            
            let recommendation;
            if (upside > 20) recommendation = 'strongBuy';
            else if (upside > 10) recommendation = 'buy';
            else if (upside > -10) recommendation = 'hold';
            else recommendation = 'sell';
            
            return {
                modelType: 'ddm',
                fairValue,
                currentPrice: stockData.price,
                upside,
                totalDividends,
                yieldOnCost,
                projectedValues,
                recommendation,
                chartData: {
                    labels: Array.from({length: years + 1}, (_, i) => `Year ${i}`),
                    values: projectedValues
                }
            };
        }

        function calculatePEG() {
            if (!stockData.pe || !stockData.epsGrowth || stockData.epsGrowth <= 0) {
                return {
                    error: true,
                    message: 'Missing P/E or EPS Growth data'
                };
            }
            
            const pegRatio = stockData.pe / stockData.epsGrowth;
            
            let rating, recommendation;
            if (pegRatio < 0.7) {
                rating = 'Strongly Undervalued';
                recommendation = 'strongBuy';
            } else if (pegRatio < 1.0) {
                rating = 'Undervalued';
                recommendation = 'strongBuy';
            } else if (pegRatio < 1.3) {
                rating = 'Fairly Valued';
                recommendation = 'buy';
            } else if (pegRatio < 1.7) {
                rating = 'Slightly Overvalued';
                recommendation = 'hold';
            } else if (pegRatio < 2.0) {
                rating = 'Overvalued';
                recommendation = 'hold';
            } else {
                rating = 'Strongly Overvalued';
                recommendation = 'sell';
            }
            
            return {
                modelType: 'peg',
                pegRatio,
                rating,
                recommendation,
                pe: stockData.pe,
                growth: stockData.epsGrowth,
                chartData: {
                    value: pegRatio,
                    zones: [
                        {label: 'Undervalued', max: 1.0, color: '#00D084'},
                        {label: 'Fair', max: 2.0, color: '#FFA500'},
                        {label: 'Overvalued', max: 3.0, color: '#FF4545'}
                    ]
                }
            };
        }

        function calculateGraham() {
            if (!stockData.eps || !stockData.pb) {
                return {
                    error: true,
                    message: 'Missing EPS or P/B data'
                };
            }
            
            const bookValue = stockData.price / stockData.pb;
            const grahamNumber = Math.sqrt(22.5 * stockData.eps * bookValue);
            const marginOfSafety = ((grahamNumber - stockData.price) / grahamNumber) * 100;
            
            let recommendation;
            if (marginOfSafety > 30) recommendation = 'strongBuy';
            else if (marginOfSafety > 15) recommendation = 'buy';
            else if (marginOfSafety > 0) recommendation = 'hold';
            else recommendation = 'sell';
            
            return {
                modelType: 'graham',
                grahamNumber,
                currentPrice: stockData.price,
                marginOfSafety,
                recommendation,
                chartData: {
                    labels: ['Graham Number', 'Current Price'],
                    values: [grahamNumber, stockData.price]
                }
            };
        }

        function displayResults(result) {
            if (result.error) {
                alert(result.message);
                return;
            }
            
            const section = document.getElementById('resultsSection');
            section.classList.add('show');
            
            // Update header
            document.getElementById('companyName').textContent = stockData.company;
            document.getElementById('tickerSymbol').textContent = stockData.ticker;
            
            const t = translations[currentLanguage];
            const recText = t.recommendations[result.recommendation];
            const recEl = document.getElementById('recommendation');
            recEl.textContent = recText;
            recEl.className = 'recommendation';
            
            if (result.recommendation === 'strongBuy' || result.recommendation === 'buy') {
                recEl.classList.add('buy');
            } else if (result.recommendation === 'hold') {
                recEl.classList.add('hold');
            } else {
                recEl.classList.add('sell');
            }
            
            // Update metrics
            const metricsContainer = document.getElementById('metricsContainer');
            metricsContainer.innerHTML = generateMetricsHTML(result);
            
            // Update chart
            createChart(result);
            
            // Scroll to results
            section.scrollIntoView({ behavior: 'smooth' });
        }

        function generateMetricsHTML(result) {
            let html = '';
            
            switch(result.modelType) {
                case 'scoring':
                    html = `
                        <div class="metric-row">
                            <span class="metric-label">Score:</span>
                            <span class="metric-value">${result.score}/100</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Grade:</span>
                            <span class="metric-value">${result.grade}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Profitability:</span>
                            <span class="metric-value">${result.breakdown.profitability}/30</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Valuation:</span>
                            <span class="metric-value">${result.breakdown.valuation}/25</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Growth:</span>
                            <span class="metric-value">${result.breakdown.growth}/20</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Financial Health:</span>
                            <span class="metric-value">${result.breakdown.financial}/15</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Dividend:</span>
                            <span class="metric-value">${result.breakdown.dividend}/10</span>
                        </div>
                    `;
                    break;
                    
                case 'dcf':
                    html = `
                        <div class="metric-row">
                            <span class="metric-label">Fair Value:</span>
                            <span class="metric-value">$${result.fairValue.toFixed(2)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Current Price:</span>
                            <span class="metric-value">$${result.currentPrice.toFixed(2)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Upside:</span>
                            <span class="metric-value">${result.upside > 0 ? '+' : ''}${result.upside.toFixed(1)}%</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Projected (${investmentHorizon}yr):</span>
                            <span class="metric-value">$${result.projectedValues[result.projectedValues.length - 1].toFixed(2)}</span>
                        </div>
                    `;
                    break;
                    
                case 'ddm':
                    html = `
                        <div class="metric-row">
                            <span class="metric-label">Fair Value:</span>
                            <span class="metric-value">$${result.fairValue.toFixed(2)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Upside:</span>
                            <span class="metric-value">${result.upside > 0 ? '+' : ''}${result.upside.toFixed(1)}%</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Total Dividends (${investmentHorizon}yr):</span>
                            <span class="metric-value">$${result.totalDividends.toFixed(2)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Yield on Cost:</span>
                            <span class="metric-value">${result.yieldOnCost.toFixed(1)}%</span>
                        </div>
                    `;
                    break;
                    
                case 'peg':
                    html = `
                        <div class="metric-row">
                            <span class="metric-label">PEG Ratio:</span>
                            <span class="metric-value">${result.pegRatio.toFixed(2)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Rating:</span>
                            <span class="metric-value">${result.rating}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">P/E Ratio:</span>
                            <span class="metric-value">${result.pe.toFixed(2)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">EPS Growth:</span>
                            <span class="metric-value">${result.growth.toFixed(1)}%</span>
                        </div>
                    `;
                    break;
                    
                case 'graham':
                    html = `
                        <div class="metric-row">
                            <span class="metric-label">Graham Number:</span>
                            <span class="metric-value">$${result.grahamNumber.toFixed(2)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Current Price:</span>
                            <span class="metric-value">$${result.currentPrice.toFixed(2)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Margin of Safety:</span>
                            <span class="metric-value">${result.marginOfSafety > 0 ? '+' : ''}${result.marginOfSafety.toFixed(1)}%</span>
                        </div>
                    `;
                    break;
            }
            
            return html;
        }

        function createChart(result) {
            const canvas = document.getElementById('resultChart');
            const ctx = canvas.getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            let config = {};
            
            switch(result.modelType) {
                case 'scoring':
                    config = {
                        type: 'bar',
                        data: {
                            labels: result.chartData.labels,
                            datasets: [{
                                label: 'Score',
                                data: result.chartData.values,
                                backgroundColor: '#00D084',
                                borderColor: '#00D084',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                x: {
                                    max: 30,
                                    ticks: { color: '#E0E0E0' },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                },
                                y: {
                                    ticks: { color: '#E0E0E0' },
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                                }
                            }
                        }
                    };
                    break;
                    
                case 'dcf':
                case 'ddm':
                    config = {
                        type: 'line',
                        data: {
                            labels: result.chartData.labels,
                            datasets: [{
                                label: 'Projected Value',
                                data: result.chartData.values,
                                borderColor: '#00D084',
                                backgroundColor: 'rgba(0, 208, 132, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 5,
                                pointBackgroundColor: '#00D084'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    ticks: {
                                        color: '#E0E0E0',
                                        callback: (value) => '$' + value.toFixed(0)
                                    },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                },
                                x: {
                                    ticks: { color: '#E0E0E0' },
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                                }
                            }
                        }
                    };
                    break;
                    
                case 'peg':
                    config = {
                        type: 'doughnut',
                        data: {
                            labels: ['PEG Ratio', 'Remaining'],
                            datasets: [{
                                data: [result.pegRatio, Math.max(0, 3 - result.pegRatio)],
                                backgroundColor: [
                                    result.pegRatio < 1 ? '#00D084' : result.pegRatio < 2 ? '#FFA500' : '#FF4545',
                                    'rgba(255, 255, 255, 0.1)'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    };
                    break;
                    
                case 'graham':
                    config = {
                        type: 'bar',
                        data: {
                            labels: result.chartData.labels,
                            datasets: [{
                                label: 'Value ($)',
                                data: result.chartData.values,
                                backgroundColor: ['#00D084', '#FFA500'],
                                borderColor: ['#00D084', '#FFA500'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    ticks: {
                                        color: '#E0E0E0',
                                        callback: (value) => '$' + value.toFixed(0)
                                    },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                },
                                x: {
                                    ticks: { color: '#E0E0E0' },
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                                }
                            }
                        }
                    };
                    break;
            }
            
            currentChart = new Chart(ctx, config);
        }
    </script>
</body>
</html>
